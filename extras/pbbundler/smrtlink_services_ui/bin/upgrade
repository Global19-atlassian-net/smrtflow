#!/usr/bin/env bash

set -e

# 1. This will startup the db (if it's not running)
# 2. Run dbctl migrate --sqlite-path=/path/file.sqlite -m legacy-migration.json
# 3. Shut down db if it wasn't originally running

__dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
rootBundleDir=$(dirname "${__dir}")

config=${rootBundleDir}/smrtlink-system-config.json
legacyConfig=${rootBundleDir}/legacy-db.json
migrationState=${rootBundleDir}/legacy-migration.json

if ! [ -e "$config" ]; then
    echo "file ${config} does not exist"
    exit 1
fi

if [ -e "$legacyConfig" ]; then
    sqliteLegacyDb=$(python -c "import json,os,sys; d=json.load(open(sys.argv[1])); print os.path.abspath(d['PB_DB_URI'])" ${legacyConfig})
    # Use the default output path for the legacy migration JSON file (-m) option
    ${rootBundleDir}/bin/dbctrl migrate -c ${config} --legacy-migration-json ${migrationState} --sqlite-path=${sqliteLegacyDb} --log-level=DEBUG
else
    # Install from a fresh install (create users/db/tables if necessary)
    ${rootBundleDir}/bin/dbctrl setup -c ${config}
fi
